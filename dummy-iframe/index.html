<!DOCTYPE html>
<html>
  <head>
    <title>Dummy IFrame Test</title>
    <meta charset="utf-8">
    <style>
      .missing {
        background-color: red;
      }
    </style>
  </head>
  <body>
  <iframe name="st-iframe" id="st-iframe" style="display: none;"></iframe>
    <form method="POST" name="st-form" id="st-form" target="st-iframe" id="st-form">
    </form>
    <script src="thirdparty/jquery.min.js"></script>
    <script src="thirdparty/tabletop.js"></script>
    <script>

      /*

        Generate a form element based on a form item in the config options.

        Returns a <div> with a label and whatever the element is.
        
        The element is one of:

        a <textarea>
        a <select> with <option>s,
        an <input> (for type="text", type="number", etc.)
        a <div> with several <inputs> (for type="radio" or type="checkbox")

      */
      function getFormElement(item) {

        var $el,
            $outer = $("<div></div>");

        $outer.append("<label>" + item.name + "</label>");

        if (item.type == "textarea") {

          $el = $("<textarea></textarea>")
                  .attr("name",item.field);
        
        } else if (item.type == "select") {
          $el = $("<select></select>")
                  .attr("name",item.field);

          $.each(item.choices,function(i,c){
            
            $el.append(

              $("<option></option>").text(c)

            );

          });

        } else if (item.type == "radio" || item.type == "checkbox") {

          $el = $("<div></div>");

          $.each(item.choices,function(i,c){

            var $i = $("<input/>").attr({
                  "name": item.field,
                  "type": item.type,
                  "value": c
                }),
                $s = $("<span/>").text(c);

            $el.append($i);
            $el.append($s);

          });
        } else {

          $el = $("<input/>").attr({
            "name": item.field,
            "type": item.type,
            "value": ""
          });

        }

        $outer.append($el);

        return $outer;

      }

      /*
        Called upon successful form submission
      */
      function submitted() {

        try {

          //Big random number into localStorage to mark that they submitted it
          localStorage.setItem("st-id", Math.floor(Math.random()*999999999));

        } catch(e) {}

        //Take hover/click listeners off the grid

      }

      function renderGrid(gridData,config) {
        gridData = $.map(gridData,function(d){
          d.x = +d.x;
          d.y = +d.y;
          return d;
        });

        //Render the grid here
      }

      /*
        Initialize everything from a set of config options
      */
      function initFromConfig(config) {

        var $form = $("form#st-form"),
            $iframe = $("iframe#st-iframe");

        if (config.dataSource.type == "google") {

          Tabletop.init({ key: config.dataSource.url,
                          callback: function(data) {
                              renderGrid(data,config);
                            },
                          simpleSheet: true
                        });

        } else if (config.dataSource.type == "json") {
          $.getJSON(config.dataSource.url,function(data){
            renderGrid(data,config);
          });
        } else {
          $.get(config.dataSource.url,function(data){
            //Need to pick a parser for this
            //renderGrid(csv2json(data),config);
          });
        }

        //Don't populate the form or set listeners if they already submitted
        try {
          if (localStorage.getItem("st-id")) return true;
        } catch (e) {}

        //Add the listener for the iframe that will get the submission
        $iframe.on("load",submitted);

        //Set the form action
        $form.attr("action",config.dataDestination)
              .on("submit",function(){

                //When they submit, check for missing required fields
                $(".missing").removeClass("missing");

                var $missing = $.map(config.fields,function(f){

                                var tag = (f.type == "select" || f.type == "textarea") ? f.type : "input",
                                    $tag = $(tag + "[name='" + f.field + "']");



                                if (f.required && (!$tag.val() || !$tag.val().length)) {
                                  return $tag;
                                }

                                return false;

                              });

                $missing = $.grep($missing,function(f){
                  return f !== false;
                });

                if ($missing.length) {

                  $.each($missing,function(i,$m){

                    $m.addClass("missing");

                  });

                  return false;
                }

                return true;

              });

        //Create the form fields
        $.each(config.fields,function(i,f){
          $form.append(getFormElement(f));
        });

        //Append a submit button
        $form.append("<input type=\"submit\" value=\"Submit\"/>");

      }

      //Main initializer
      function sentimentTracker(opt) {
        if (typeof opt == "string") {
          $.getJSON(opt,initFromConfig);
        } else {
          initFromConfig(opt);
        }
      }

      sentimentTracker("sample-form-config.json");

    </script>
  </body>
</html>